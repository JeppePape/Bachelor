#!/bin/bash

# === CONFIG ===
OKVIS_BIN=~/Desktop/okvis2/build/okvis_app_synchronous
CONFIG=~/Desktop/okvis2/config/euroc.yaml
DATASET_ROOT=/mnt/hgfs/Bags/MavEurocFormat
RESOURCE_LOGGER=/mnt/hgfs/Bags/MavEurocFormat/log_resources_okvis2.sh
LOG_NAME="OKVIS2_ASL_log.csv"
.csv

# === MAIN LOOP ===
for folder in "$DATASET_ROOT"/*; do
  if [[ -d "$folder/mav0" ]]; then
    echo "=== Running OKVIS2 on: $folder ==="

    # Clean old logs
    rm -f /tmp/$LOG_NAME

    # Start resource logger
    LOG_PATH="$folder/mav0/$LOG_NAME"
    bash "$RESOURCE_LOGGER" "$LOG_PATH" &
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    LOGGER_PID=$!

    # Run OKVIS2
    "$OKVIS_BIN" "$CONFIG" "$folder/mav0" > "$folder/mav0/okvis2_output.log" 2>&1

    # Stop logger
    kill $LOGGER_PID
    wait $LOGGER_PID 2>/dev/null

    # Move log into the dataset folder
    mv "$DATASET_ROOT/$LOG_NAME" "$folder/mav0/"

    echo "âœ” Done: $folder"
  else
    echo "Skipping $folder (no mav0/ directory)"
  fi
done
